FROM --platform=linux/amd64 node:18-alpine3.17

ENV YARN_VERSION 1.22.19

# install OpenSSL 1.1.x, needed for Linux Alpine 3.17+
RUN apk update \
  && apk add openssl1.1-compat

# Add curl for alpine based image
RUN apk add --no-cache --virtual .build-deps-yarn curl \
    && curl -fSLO --compressed "https://yarnpkg.com/downloads/$YARN_VERSION/yarn-v$YARN_VERSION.tar.gz" \
    && tar -xzf yarn-v$YARN_VERSION.tar.gz -C /opt/ \
    && ln -snf /opt/yarn-v$YARN_VERSION/bin/yarn /usr/local/bin/yarn \
    && ln -snf /opt/yarn-v$YARN_VERSION/bin/yarnpkg /usr/local/bin/yarnpkg \
    && rm yarn-v$YARN_VERSION.tar.gz \
    && apk del .build-deps-yarn

WORKDIR /usr/src/app

COPY package*.json ./

COPY yarn.lock ./

COPY prisma ./prisma/

COPY .env ./

COPY tsconfig.json ./

COPY . .

RUN apk add --update --no-cache openssl1.1-compat

RUN yarn

RUN yarn prisma generate

EXPOSE 3000

# Command to run when the container is ready
# Separate arguments as separate values in the array
CMD [ "yarn", "start"]